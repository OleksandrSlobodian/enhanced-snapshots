var app=angular.module("web",["ui.router","angularAwesomeSlider","ui.bootstrap","smart-table","ngTagsInput","ngStomp","toastr"]);app.constant("BASE_URL","./"),app.constant("ITEMS_BY_PAGE",25),app.constant("DISPLAY_PAGES",7),app.config(["$stateProvider","$urlRouterProvider","$httpProvider",function(a,b,c){b.otherwise("/loader");var d=["$rootScope",function(a){if(angular.isUndefined(a.getUserName()))throw"User not authorized!";return!0}],e=["$rootScope",function(a){if(!a.isConfigState())throw"System is not in configuration state!";return!0}],f=["System","$q","$rootScope",function(a,b,c){c.isLoading=!0;var d=b.defer();return a.get().then(function(a){c.isLoading=!1,d.resolve(a)},function(){c.isLoading=!1,d.reject(!1)}),d.promise}],g=["$q","Users",function(a,b){var c=b.getCurrent();return Boolean(c)?a.resolve(c):a.reject()}],h=["Users","$q","Storage","Auth","$rootScope","System",function(a,b,c,d,e,f){e.isLoading=!0;var g=b.defer(),h=[f.get(),a.refreshCurrent()];return b.all(h).then(function(a){void 0!=a[0].ssoMode&&c.save("ssoMode",{ssoMode:a[0].ssoMode}),200===a[1].status?g.resolve(a[1].status):g.resolve(!1)},function(a){if(401===a.status){var b=a.data&&a.data.loginMode&&"SSO"===a.data.loginMode;g.resolve(b)}g.resolve(!1)}),g.promise}];a.state("app",{abstract:!0,url:"/app",templateUrl:"partials/app.html",resolve:{authenticated:d},controller:["$scope","$rootScope","Storage","toastr",function(a,b,c,d){b.$on("$stateChangeSuccess",function(){var a=c.get("notification");a&&(d.info(a,void 0,{closeButton:!0,timeOut:2e4}),c.remove("notification"))}),b.isAdmin="admin"===(c.get("currentUser")||{}).role}]}).state("app.volume",{abstract:!0,template:"<ui-view></ui-view>",url:""}).state("app.volume.list",{url:"/volumes",templateUrl:"partials/volumes.html",controller:"VolumesController",resolve:{currentUser:g}}).state("app.volume.schedule",{url:"/schedule/:volumeId",templateUrl:"partials/schedule.html",controller:"ScheduleController",resolve:{currentUser:g}}).state("app.volume.history",{url:"/history/:volumeId",templateUrl:"partials/history.html",controller:"HistoryController",resolve:{currentUser:g}}).state("app.volume.tasks",{url:"/tasks/:volumeId",templateUrl:"partials/tasks.html",controller:"TasksController",resolve:{currentUser:g}}).state("app.tasks",{url:"/tasks",templateUrl:"partials/tasks.html",controller:"TasksController",resolve:{currentUser:g}}).state("app.settings",{url:"/settings",templateUrl:"partials/settings.html",controller:"SettingsController",resolve:{currentUser:g}}).state("app.users",{url:"/users",templateUrl:"partials/users.html",controller:"UserController",resolve:{ssoMode:f,currentUser:g}}).state("app.logs",{url:"/logs",templateUrl:"partials/logs.html",controller:"LogsController",resolve:{currentUser:g}}).state("config",{url:"/config",templateUrl:"partials/config.html",controller:"ConfigController",resolve:{isConfig:e}}).state("login",{url:"/login?err",templateUrl:"partials/login.html",controller:"LoginController",resolve:{refreshUserResult:h}}).state("loader",{url:"/loader",template:'<div class="loading"><div class="text-center spinner-container"><span class="glyphicon glyphicon-refresh text-muted spin"></span></div> </div>',controller:"LoaderController"}).state("logout",{url:"/logout",template:'<div class="loading"><div class="text-center spinner-container"><span class="glyphicon glyphicon-refresh text-muted spin"></span></div> </div>',controller:"LogoutController"}).state("registration",{url:"/registration",templateUrl:"partials/registration.html",controller:"RegistrationController"}),c.defaults.headers.common["X-Requested-With"]="XMLHttpRequest",c.interceptors.push("Interceptor")}]).run(["$rootScope","$state","$modal","$stomp","toastr","Storage","Users","System","$q",function(a,b,c,d,e,f,g,h,i){a.isLoading=!0;var j=f.get("currentUser"),k=f.get("ssoMode");if(!j||!k){var l=[h.get(),g.refreshCurrent()];i.all(l).then(function(c){void 0!=c[0].ssoMode&&f.save("ssoMode",{ssoMode:c[0].ssoMode}),c[1].data&&c[1].data.email?b.go("app.volume.list"):b.go("login"),a.isLoading=!1},function(b){console.log(b),a.isLoading=!1})}a.getUserName=function(){return(f.get("currentUser")||{}).email},a.isConfigState=function(){return"configurator"===(f.get("currentUser")||{}).role},a.subscribeWS=function(){d.setDebug(function(a){}),d.connect("/rest/ws").then(function(b){a.errorListener=d.subscribe("/error",function(a){e.error(a.message,a.title)}),a.taskListener=d.subscribe("/task",function(b){f.save("lastTaskStatus_"+b.taskId,b),a.$broadcast("task-status-changed",b)})},function(a){console.log(a)})},a.$on("$stateChangeError",function(c){c.preventDefault(),f.get("ssoMode")?a.isLoading=!0:b.go("login")}),a.errorListener={},a.taskListener={},angular.isDefined(a.getUserName())&&a.subscribeWS()}]),angular.module("web").controller("ConfigController",["$scope","Volumes","Configuration","$modal","$state","Storage",function(a,b,c,d,e,f){var g=6e5;a.STRINGS={s3:{empty:"Bucket name field cannot be empty",new:"New bucket will be created as",existing:"Existing bucket will be used"},db:{isValid:{true:"Database exists",false:"No database found"},hasAdminUser:{false:"You will need to create a new user on the next step"}},sdfs:{name:{new:"New volume will be created as",existing:"Existing volume will be used"},point:"At mounting point:",size:"Would you like to update volume size?"}},a.iconClass={true:"ok",false:"cog"},a.statusColorClass={true:"success",false:"danger"},a.isCustomBucketName=!1,a.isNameWrong=!1,a.wrongNameMessage="",a.isValidInstance=!0,a.selectBucket=function(b){a.selectedBucket=b,c.get("bucket/"+encodeURIComponent(b.bucketName)+"/metadata").then(function(b){a.settings.db.hasAdmin=b.data.hasAdmin},function(a){console.warn(a)})},angular.isUndefined(a.isSSO)&&(a.isSSO=!1);var h=function(){var b=d.open({animation:!0,backdrop:!1,templateUrl:"./partials/modal.wizard-progress.html",scope:a});return b.result.then(function(){e.go("login")},function(){}),b},i=function(){a.progressState="loading";var b=h();c.get("current").then(function(c,d){a.settings=c.data,a.selectedBucket=(c.data.s3||[])[0]||{},a.settings.mailConfiguration?a.emails=a.settings.mailConfiguration.recipients||[]:(a.emails=[],a.settings.mailConfiguration={events:{error:!1,info:!1,success:!1}}),b.dismiss()},function(c,d){a.isValidInstance=!1,a.invalidMessage=c.data.localizedMessage,b.dismiss()})};i(),a.emailNotifications=function(){a.connectionStatus=null;var b=d.open({animation:!0,templateUrl:"./partials/modal.email-notifications.html",scope:a,backdrop:!1});b.result.then(function(){a.settings.mailConfiguration.recipients=a.emails})},a.testConnection=function(){a.settings.mailConfiguration.recipients=a.emails;var b={testEmail:a.testEmail,domain:a.settings.domain,mailConfiguration:a.settings.mailConfiguration};c.check(b).then(function(b){a.connectionStatus=b.status},function(b){a.connectionStatus=b.status})},a.sendSettings=function(){var b=a.isNewVolumeSize?a.sdfsNewSize:a.settings.sdfs.volumeSize,e=function(){return a.settings.mailConfiguration.fromMailAddress?a.settings.mailConfiguration:null},i=function(){if(a.settings.clusterMode){var b;return b={minNodeNumber:a.settings.cluster.minNodeNumber,maxNodeNumber:a.settings.cluster.maxNodeNumber}}return null},j={bucketName:a.selectedBucket.bucketName,volumeSize:b,cluster:i(),sungardasSSO:!!a.sungardasSSO,ssoMode:a.isSSO,domain:a.settings.domain,spEntityId:a.entityId||null,mailConfiguration:e()};if(a.settings.db.hasAdmin||a.isSSO)a.progressState="running",j.ssoMode&&(j.user={email:a.adminEmail}),a.progressState="running",c.send("current",j,null,a.settings.sso).then(function(){a.progressState="success",f.save("ssoMode",{ssoMode:a.isSSO})},function(b,c){a.progressState="failed"}),h();else{a.userToEdit={isNew:!0,admin:!0};var k=d.open({animation:!0,templateUrl:"./partials/modal.user-edit.html",scope:a});k.result.then(function(){j.user=a.userToEdit,delete j.user.isNew,a.progressState="running",c.send("current",j,g).then(function(){a.progressState="success"},function(){a.progressState="failed"}),h()})}},a.validateName=function(){c.get("bucket/"+encodeURIComponent(a.selectedBucket.bucketName)).then(function(b){a.isNameWrong=!b.data.valid,a.wrongNameMessage=b.data.message},function(a,b){})}}]),angular.module("web").controller("HistoryController",["$scope","$rootScope","$q","Storage","ITEMS_BY_PAGE","DISPLAY_PAGES","$stateParams","$state","$modal","$filter","Backups","Tasks","Zones",function(a,b,c,d,e,f,g,h,i,j,k,l,m){a.maxDeleteBackupDisplay=5,a.itemsByPage=e,a.displayedPages=f,a.volumeId=g.volumeId,a.textClass={false:"Select",true:"Unselect"},a.iconClass={false:"unchecked",true:"check"},a.selectZone=function(b){a.selectedZone=b},a.isAllSelected=!1,a.selectedAmount=0,a.checkSelection=function(){a.selectedAmount=a.backups.filter(function(a){return a.isSelected}).length,a.isAllSelected=a.selectedAmount==a.backups.length},a.makeSelection=function(){a.backups.forEach(function(b){b.isSelected=!a.isAllSelected}),a.checkSelection()},a.deleteSelection=function(){a.selectedBackups=a.backups.filter(function(a){return a.isSelected});var c=i.open({animation:!0,templateUrl:"./partials/modal.backup-delete.html",scope:a});c.result.then(function(){b.isLoading=!0,a.deleteErrors=[];for(var c=a.selectedBackups.map(function(a){return a.fileName}),d=c.length,e=function(){if(b.isLoading=d>0,!b.isLoading){a.deleteErrors.length&&console.log(a.deleteErrors);var c=i.open({animation:!0,templateUrl:"./partials/modal.backup-delete-result.html",scope:a});c.result.then(function(){h.go("app.tasks")},function(){n()})}},f=0;f<c.length;f++)k.delete(c[f]).then(function(){d--,e()},function(b){a.deleteErrors.push(b),d--,e()})})},b.isLoading=!1,a.backups=[];var n=function(){b.isLoading=!0,k.getForVolume(a.volumeId).then(function(c){c.forEach(function(a){a.isSelected=!1}),a.backups=c,b.isLoading=!1},function(){b.isLoading=!1})};n(),a.restore=function(e){b.isLoading=!0,c.all([m.get(),m.getCurrent()]).then(function(b){a.zones=b[0],a.selectedZone=b[1]["zone-name"]||""}).finally(function(){b.isLoading=!1}),a.objectToProcess=e;var f=i.open({animation:!0,templateUrl:"./partials/modal.history-restore.html",scope:a});f.result.then(function(){var b={id:"",priority:"",volumes:[a.objectToProcess.volumeId],backupFileName:a.objectToProcess.fileName,type:"restore",zone:a.selectedZone,status:"waiting",schedulerManual:!0,schedulerName:d.get("currentUser").email,schedulerTime:Date.now()};l.insert(b).then(function(){var b=i.open({animation:!0,templateUrl:"./partials/modal.task-created.html",scope:a});b.result.then(function(){h.go("app.tasks")})})})}}]),angular.module("web").controller("LoaderController",["Users","$state","$q","System","Storage","Auth",function(a,b,c,d,e,f){var g=[d.get(),a.refreshCurrent()];c.all(g).then(function(a){void 0!=a[0].ssoMode&&e.save("ssoMode",{ssoMode:a[0].ssoMode}),"string"!=typeof a[1].data&&200===a[1].status?b.go("app.volume.list"):(f.logOut(),b.go("login"))},function(a){})}]),angular.module("web").controller("LoginController",["$rootScope","$scope","$state","$stateParams","$stomp","Auth","System","Storage","toastr","$window","refreshUserResult",function(a,b,c,d,e,f,g,h,i,j,k){a.isLoading=!0,d.err&&"session"==d.err&&i.warning("You were logged out. Please re-login","Session expired.");var l=h.get("currentUser"),m=h.get("ssoMode");l&&l.length>1&&(m&&m.ssoMode&&(j.location.href="/saml/logout"),f.logOut()),k===!0?(a.isLoading=!0,window.location="/saml/login"):200===k&&l&&m&&void 0!=m.ssoMode?c.go("app.volume.list"):a.isLoading=!(!m||!m.ssoMode),b.clearErr=function(){b.error=""},b.login=function(){f.logIn(b.email,b.password).then(function(a){"configurator"===a.role?c.go("config"):g.get().then(function(a){a.currentVersion<a.latestVersion&&h.save("notification","Newer version is available! Please, create a new instance from the latest AMI."),b.subscribeWS()}).finally(function(){c.go("app.volume.list")})},function(a){b.error=a,b.password=""})}}]),angular.module("web").controller("LogoutController",["$state","Auth","Storage","$window",function(a,b,c,d){var e=(c.get("currentUser"),c.get("ssoMode"));e&&e.ssoMode?d.location.href="/saml/logout":(b.logOut(),a.go("login"))}]),angular.module("web").controller("LogsController",["$location","$anchorScroll","$stomp","$scope","$rootScope","$state","$timeout","$q","System",function(a,b,c,d,e,f,g,h,i){d.followLogs=!1,d.logs=[];var j;e.isLoading=!0;var k=[],l=[],m=0,n={warn:"warning",info:"info",error:"error",debug:""},o=!1;i.get().then(function(h){function i(a){function b(a,b){function c(){k.length>j&&(k=k.slice(-j))}function e(a){k=k.concat(a),c(),l=[],m=0,d.$apply(function(){d.logs=k})}b<15?e(a):a.length&&g(function(){e(a)},1e3)}a.body=JSON.parse(a.body);for(var c=function(a){var b=a.split("]")[0].split("[").reverse()[0],c=b.toLowerCase().trim();return n[c]},e=function(a){l.push(a),o||(o=!0,g(function(){var a=l.length-m;o=!1,b(l,a)},500))},f=0;f<a.body.length;f++){var h={type:c(a.body[f]),message:a.body[f]};e(h)}}"string"==typeof h&&h.indexOf('<html lang="en" ng-app="web"')>-1&&f.go("loader"),j=h.systemProperties.logsBuffer,c.connect("/rest/ws").then(function(f){e.isLoading=!1,d.logsListener=c.subscribe("/logs",function(c,e,f){if(i(f),d.followLogs){var g="log-"+(d.logs.length?d.logs.length-1:0);a.hash(g),b()}})},function(a){e.isLoading=!1,console.log(a)})}),e.$on("$stateChangeStart",function(a,b,c,f,g,h){e.isLoading=!1,"app.logs"===f.name&&d.logsListener&&d.logsListener.unsubscribe()})}]),angular.module("web").controller("RegistrationController",["$scope","$state","Users","$modal",function(a,b,c,d){a.passwordError="",a.userExists="";var e={};a.registerUser=function(){a.passwordReg===a.passwordConf?c.getAll().then(function(f){var g=!0;if(f)for(var h=0;h<f.length;h++)if(f[h].email===e.email){g=!1,a.userExists="User with such E-mail already exists";break}g&&(e={firstName:a.firstName,lastName:a.lastName,email:a.userEmail,password:a.passwordReg},c.insert(e).then(function(){var a=d.open({animation:!0,templateUrl:"./partials/modal.user-added.html"});a.result.then(function(){b.go("login")})}))}):a.passwordError="Password does not match"}}]),angular.module("web").controller("ScheduleController",["$scope","$rootScope","$stateParams","$filter","Tasks","$modal",function(a,b,c,d,e,f){a.volumeId=c.volumeId,a.schedules=[];var g=function(){e.getRegular(a.volumeId).then(function(b){a.schedules=b})};g();var h=function(b){return{cron:b.cron,enabled:b.enabled,id:b.id,regular:"true",schedulerManual:"false",schedulerName:b.name,status:"waiting",type:"backup",volumes:[a.volumeId]}},i=function(a){return{isNew:!1,id:a.id,name:a.schedulerName,enabled:"true"==a.enabled,cron:a.cron}};a.add=function(){a.scheduleToEdit={isNew:!0,id:null,name:"",enabled:!0};var c=f.open({animation:!0,templateUrl:"./partials/modal.schedule-edit.html",scope:a});c.result.then(function(){b.isLoading=!0;var c=h(a.scheduleToEdit);e.insert(c).then(function(){g(),b.isLoading=!1},function(){b.isLoading=!1})})},a.edit=function(c){a.scheduleToEdit=i(c);var d=f.open({animation:!0,templateUrl:"./partials/modal.schedule-edit.html",scope:a});d.result.then(function(){b.isLoading=!0;var c=h(a.scheduleToEdit);e.update(c).then(function(){g(),b.isLoading=!1},function(){b.isLoading=!1})})},a.remove=function(b){a.scheduleToDelete=b;var c=f.open({animation:!0,templateUrl:"./partials/modal.schedule-del.html",scope:a});c.result.then(function(){e.delete(b.id).then(function(a){g()})})}}]),angular.module("web").controller("SettingsController",["$rootScope","$state","$scope","System","currentUser","Users","$modal","Configuration",function(a,b,c,d,e,f,g,h){a.isLoading=!1;var e=f.getCurrent();c.isAdmin="admin"===e.role,c.STRINGS={sdfs:{sdfsLocalCacheSize:{empty:"Local Cache Size field cannot be empty."},volumeSize:{empty:"Volume Size field cannot be empty."}},volumeType:{empty:"Volume size for io1 volume type cannot be empty.",range:"Volume size for io1 volume type must be in between 1 and 50."},otherSettings:{empty:"All fields are required. Please fill in empty fields."}},a.isLoading=!0,d.get().then(function(d){"string"==typeof d&&d.indexOf('<html lang="en" ng-app="web"')>-1&&b.go("loader"),d.ec2Instance.instanceIDs=d.ec2Instance.instanceIDs.join(", "),c.settings=d,c.settings.mailConfiguration?c.emails=c.settings.mailConfiguration.recipients||[]:(c.emails=[],c.settings.mailConfiguration={events:{error:!1,info:!1,success:!1}}),c.initialSettings=angular.copy(d),a.isLoading=!1},function(b){console.log(b),a.isLoading=!1}),c.backup=function(){var a=c.$new(!0);g.open({animation:!0,templateUrl:"./partials/modal.system-backup.html",scope:a,controller:"modalSystemBackupCtrl"})},c.uninstall=function(){g.open({animation:!0,templateUrl:"./partials/modal.system-uninstall.html",controller:"modalSystemUninstallCtrl"})},c.updateSettings=function(){var a=g.open({animation:!0,scope:c,templateUrl:"./partials/modal.settings-update.html",controller:"modalSettingsUpdateCtrl"});a.result.then(function(){c.initialSettings=angular.copy(c.settings)},function(){c.initialSettings=angular.copy(c.settings)})},c.emailNotifications=function(){c.connectionStatus=null;var a=g.open({animation:!0,templateUrl:"./partials/modal.email-notifications.html",scope:c});a.result.then(function(){c.settings.mailConfiguration.recipients=c.emails},function(){c.settings=angular.copy(c.initialSettings)})},c.testConnection=function(){var a={testEmail:c.testEmail,domain:c.settings.domain,mailConfiguration:c.settings.mailConfiguration};h.check(a).then(function(a){c.connectionStatus=a.status},function(a){c.connectionStatus=a.status})},c.isNewValues=function(){return JSON.stringify(c.settings)!==JSON.stringify(c.initialSettings)}}]),angular.module("web").controller("TasksController",["$scope","$rootScope","$stateParams","$stomp","Tasks","Storage","$modal","$timeout","$state",function(a,b,c,d,e,f,g,h,i){a.typeColorClass={backup:"primary",restore:"success",delete:"danger",system_backup:"danger"},a.typeIconClass={backup:"cloud-download",restore:"cloud-upload",delete:"remove",system_backup:"cog"},a.manualIconClass={true:"user",false:"time"},a.statusPriority=function(a){var b={canceled:5,running:4,queued:3,error:2,waiting:1};return b[a.status]||0},a.typePriority=function(a){return parseInt(a.priority)||0},a.volumeId=c.volumeId,a.tasks=[],b.isLoading=!1,a.refresh=function(){b.isLoading=!0,e.get(a.volumeId).then(function(c){"string"==typeof c&&c.indexOf('<html lang="en" ng-app="web"')>-1&&i.go("logout"),a.tasks=c,j(),b.isLoading=!1},function(){b.isLoading=!1})},a.refresh(),a.$on("task-status-changed",function(a,b){k(b)});var j=function(){for(var b=0;b<a.tasks.length;b++){var c=a.tasks[b],d=f.get("lastTaskStatus_"+c.id)||{};c.progress=d.progress,c.message=d.message}},k=function(b){var c=a.tasks.filter(function(a){return a.id==b.taskId&&"complete"!=b.status})[0];c&&("complete"==c.status||"queued"==c.status||"waiting"==c.status?a.refresh():(h(function(){c.progress=b.progress,c.message=b.message,c.status=b.status},0),100==b.progress&&(f.remove("lastTaskStatus_"+c.id),a.refresh())))};a.reject=function(b){a.taskToReject=b;var c=g.open({animation:!0,templateUrl:"./partials/modal.task-reject.html",scope:a});c.result.then(function(){e.delete(b.id).then(function(){a.refresh()})})}}]),angular.module("web").controller("UserController",["$state","$scope","$rootScope","Users","ssoMode","Storage","toastr","$modal","ITEMS_BY_PAGE","DISPLAY_PAGES",function(a,b,c,d,e,f,g,h,i,j){b.itemsByPage=i,b.displayedPages=j,b.users=[],b.ssoMode=e.ssoMode;var k=d.getCurrent();b.isAdmin="admin"===k.role,b.isCurrentUser=function(a){return k.email===a};var l=function(){if(b.isCurrentUser(b.userToEdit.email)){var a=angular.copy(b.userToEdit);delete a.isNew,delete a.password,delete a.admin,a.role=b.userToEdit.admin?"admin":"user",f.save("currentUser",a)}};b.editUser=function(a){b.userToEdit=angular.copy(a),b.userToEdit.isNew=!1;var e=h.open({animation:!0,templateUrl:"./partials/modal.user-edit.html",scope:b});e.result.then(function(){c.isLoading=!0,b.userToEdit.password=b.userToEdit.password||"",d.update(b.userToEdit).then(function(){b.refreshUsers(),l();h.open({animation:!0,templateUrl:"./partials/modal.user-added.html",scope:b});c.isLoading=!1},function(a){c.isLoading=!1})})},b.addUser=function(){b.userToEdit={},b.userToEdit.isNew=!0,b.userToEdit.admin=!1;var a=h.open({animation:!0,templateUrl:"./partials/modal.user-edit.html",scope:b});a.result.then(function(){c.isLoading=!0,d.insert(b.userToEdit).then(function(){var a=h.open({animation:!0,templateUrl:"./partials/modal.user-added.html",scope:b},function(a){console.log(a)});a.result.then(function(){b.refreshUsers()}),c.isLoading=!1},function(a){c.isLoading=!1})})},d.getAll().then(function(c){"string"==typeof c&&c.indexOf('<html lang="en" ng-app="web"')>-1&&a.go("loader"),b.users=c}),b.refreshUsers=function(){c.isLoading=!0,b.users=[],d.getAll().then(function(a){b.users=a,c.isLoading=!1},function(){c.isLoading=!1})},b.deleteUser=function(a){b.userToDelete=a;var e=h.open({animation:!0,templateUrl:"./partials/modal.user-delete.html",scope:b});e.result.then(function(){c.isLoading=!0,d.delete(a.email).then(function(){b.refreshUsers(),c.isLoading=!1},function(){c.isLoading=!1})})}}]),angular.module("web").controller("VolumesController",["$scope","$rootScope","$state","$q","Retention","$filter","Storage","Regions","ITEMS_BY_PAGE","DISPLAY_PAGES","$modal","Volumes","Tasks","Zones",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){a.maxVolumeDisplay=5,a.itemsByPage=i,a.displayedPages=j,a.stateColorClass={"in-use":"success",creating:"error",available:"info",deleting:"error",deleted:"error",error:"error",removed:"danger"},a.textClass={false:"Select",true:"Unselect"},a.iconClass={false:"unchecked",true:"check"};var o={backup:{type:"backup",bgClass:"primary",modalTitle:"Backup Volume",iconClass:"cloud-download",description:"start backup task",buttonText:"Add backup task"},restore:{type:"restore",bgClass:"success",modalTitle:"Restore Backup",iconClass:"cloud-upload",description:"start restore task",buttonText:"Add restore task"},schedule:{type:"schedule",bgClass:"warning",modalTitle:"Add Schedule",iconClass:"time",description:"add schedule",buttonText:"Add schedule"}};a.isAllSelected=!1,a.selectedAmount=0,a.checkAllSelection=function(){var b=a.volumes.filter(function(b){return a.isDisabled(b)}).length;a.selectedAmount=a.volumes.filter(function(a){return a.isSelected}).length,a.isAllSelected=a.selectedAmount+b==a.volumes.length},a.selectAll=function(){a.volumes.forEach(function(b){p(b,!a.isAllSelected)}),a.checkAllSelection()},a.toggleSelection=function(b){p(b,!b.isSelected),a.checkAllSelection()};var p=function(a,b){a.hasOwnProperty("isSelected")&&(a.isSelected=b)};a.isDisabled=function(a){return"removed"===a.state},a.showFilter=function(){var b=k.open({animation:!0,templateUrl:"./partials/modal.volume-filter.html",controller:"modalVolumeFilterCtrl",resolve:{tags:function(){return a.tags},instances:function(){return a.instances}}});b.result.then(function(b){a.stAdvancedFilter=b})};var q=function(b){a.tags={},a.instances=[""];for(var c=0;c<b.length;c++){for(var d=0;d<b[c].tags.length;d++){var e=b[c].tags[d];a.tags.hasOwnProperty(e.key)?a.tags[e.key].indexOf(e.value)==-1&&a.tags[e.key].push(e.value):a.tags[e.key]=[e.value]}var f=b[c].instanceID;f&&a.instances.indexOf(f)==-1&&a.instances.push(f),"removed"!==b[c].state&&(b[c].isSelected=!1)}return a.isAllSelected=!1,b};a.changeRegion=function(b){a.selectedRegion=b},a.refresh=function(){b.isLoading=!0,a.volumes=[],l.get().then(function(d){"string"==typeof d&&d.indexOf('<html lang="en" ng-app="web"')>-1&&c.go("loader"),a.volumes=q(d),b.isLoading=!1},function(){b.isLoading=!1})},a.refresh(),a.selectZone=function(b){a.selectedZone=b},a.volumeAction=function(e){b.isLoading=!0,d.all([n.get(),n.getCurrent()]).then(function(b){a.zones=b[0],a.selectedZone=b[1]["zone-name"]||""}).finally(function(){b.isLoading=!1}),a.selectedVolumes=a.volumes.filter(function(a){return a.isSelected}),a.actionType=e,a.action=o[e],a.schedule={name:"",cron:"",enabled:!0};var f=k.open({animation:!0,templateUrl:"./partials/modal.volumeAction.html",scope:a});f.result.then(function(){b.isLoading=!0;var d=a.selectedVolumes.map(function(a){return a.volumeId}),f=function(){var b={id:"",priority:"",volumes:d,status:"waiting"};switch(e){case"restore":b.backupFileName="",b.zone=a.selectedZone;case"backup":b.type=e,b.schedulerManual=!0,b.schedulerName=g.get("currentUser").email,b.schedulerTime=Date.now();break;case"schedule":b.type="backup",b.regular=!0,b.schedulerManual=!1,b.schedulerName=a.schedule.name,b.cron=a.schedule.cron,b.enabled=a.schedule.enabled}return b},h=f();m.insert(h).then(function(){if(b.isLoading=!1,"schedule"!=e){var d=k.open({animation:!0,templateUrl:"./partials/modal.task-created.html",scope:a});d.result.then(function(){c.go("app.tasks")})}},function(a){b.isLoading=!1,console.log(a)})})};var r=function(b){var c={};return angular.forEach(a.rule,function(a,b){c[b]=a>0}),Object.defineProperty(c,"never",{get:function(){return!a.showRetentionRule.size&&!a.showRetentionRule.count&&!a.showRetentionRule.days},set:function(b){b&&(a.showRetentionRule.size=!1,a.showRetentionRule.count=!1,a.showRetentionRule.days=!1)}}),c};a.retentionRule=function(c){b.isLoading=!0,e.get(c.volumeId).then(function(c){a.rule={size:c.size,count:c.count,days:c.days},a.showRetentionRule=r(a.rule),b.isLoading=!1;var d=k.open({animation:!0,templateUrl:"./partials/modal.retention-edit.html",scope:a});d.result.then(function(){b.isLoading=!0;var d=angular.copy(a.rule);angular.forEach(d,function(b,c){d[c]=a.showRetentionRule[c]?d[c]:0}),d.volumeId=c.volumeId,e.update(d).then(function(){b.isLoading=!1},function(){b.isLoading=!1})})},function(){b.isLoading=!1})}}]),angular.module("web").controller("modalScheduleCtrl",["$scope","$modalInstance","$filter","schedule","Schedules",function(a,b,c,d,e){a.Schedules=e,a.schedule=d,a.isNew=0==d.id,a.schedule=angular.copy(d),a.isEndless="undefined"==typeof a.schedule.end||!a.schedule.end,a.weekdays={Monday:!1,Tuesday:!1,Wednesday:!1,Thursday:!1,Friday:!1,Saturday:!1,Sunday:!1},a.shortdays={Monday:"Mo",Tuesday:"Tu",Wednesday:"We",Thursday:"Th",Friday:"Fr",Saturday:"Sa",Sunday:"Su"};for(var f in a.weekdays)a.weekdays[f]=a.schedule.week.indexOf(f)>=0;a.doEndless=function(){a.isEndless?a.schedule.end="":(a.schedule.end=a.schedule.start,a.schedule.end.setDate(a.schedule.start.getDate()+1))},a.periodicityNum=[1,2,3,4,5,10,15],a.periodicityWord=["day","week","month","year"],a.opened={start:!1,end:!1},a.today=function(){a.dt=new Date},a.clear=function(){a.dt=null},a.calendarOpen=function(b,c){b.preventDefault(),b.stopPropagation(),a.opened[c]=!0},a.ok=function(){a.schedule.week=Object.keys(a.weekdays).filter(function(b){return a.weekdays[b]}),a.schedule.start=c("date")(a.schedule.start,"yyyy-MM-dd hh:mm:ss"),a.schedule.end=function(){return null!=a.schedule.end&&a.schedule.end?c("date")(a.schedule.end,"yyyy-MM-dd hh:mm:ss"):""}(),a.isNew?e.insert(a.schedule).then(function(){b.close()}):e.update(a.schedule).then(function(){b.close()})},a.cancel=function(){b.dismiss()}}]),angular.module("web").controller("modalSettingsUpdateCtrl",["$scope","$modalInstance","System","Tasks","$rootScope",function(a,b,c,d,e){a.state="ask";var f=angular.copy(a.settings);f.mailConfiguration.fromMailAddress||(f.mailConfiguration=null),delete f.systemProperties.volumeTypeOptions,delete f.ec2Instance.instanceIDs,a.updateSettings=function(){e.isLoading=!0,c.send(f).then(function(){a.state="done",e.isLoading=!1},function(b){a.state="failed",e.isLoading=!1})}}]),angular.module("web").controller("modalSystemBackupCtrl",["$scope","$modalInstance","Tasks","Storage",function(a,b,c,d){a.state="ask",a.sendTask=function(){var b={type:"system_backup",status:"waiting",regular:"false",schedulerManual:!0,schedulerName:d.get("currentUser").email,schedulerTime:Date.now()};c.insert(b).then(function(){a.state="done"},function(){a.state="failed"})}}]),angular.module("web").controller("modalSystemUninstallCtrl",["$scope","$modalInstance","System",function(a,b,c){a.state="ask",a.deletionOptions=[{name:"Yes",value:!0},{name:"No",value:!1}],a.delete=function(){var b={systemId:a.systemId,removeS3Bucket:a.removeS3Bucket.value};c.delete(b).then(function(){a.state="done"},function(b){a.delError=b,a.state="failed"})}}]),angular.module("web").controller("modalVolumeFilterCtrl",["$scope","$modalInstance","Regions","Storage","tags","instances",function(a,b,c,d,e,f){a.tags=e,a.instances=f,a.globalRegion={location:"",name:"GLOBAL",id:""},a.sliderOptions={from:0,to:16384,step:4,dimension:" GiB",skin:"plastic"},c.get().then(function(b){a.regions=b}),a.clear=function(){var b={volumeId:"",name:"",size:"0;16384",instanceID:"",region:a.globalRegion,tags:[]};a.filter=angular.copy(b)},d.get("VolumeFilter")?a.filter=d.get("VolumeFilter"):a.clear(),a.ok=function(){var c=a.filter,e={volumeId:{type:"str",value:c.volumeId},volumeName:{type:"str",value:c.name},size:{type:"int-range",value:{lower:parseInt(c.size.split(";")[0],10),higher:parseInt(c.size.split(";")[1],10)}},instanceID:{type:"str-strict",value:c.instanceID},availabilityZone:{type:"str",value:c.region.id},tags:{type:"array-inc",value:c.tags}};d.save("VolumeFilter",c),b.close(e)}}]),app.directive("autoScroll",function(){return{scope:{autoScroll:"="},link:function(a,b,c){a.$watchCollection("autoScroll",function(a){a&&JSON.parse(c.enableScroll)&&$(b).scrollTop($(b)[0].scrollHeight+$(b)[0].clientHeight)})}}}),app.directive("checkPassword",[function(){return{require:"ngModel",link:function(a,b,c,d){var e="#"+c.checkPassword;b.bind("keyup",function(){a.$apply(function(){var a=angular.element(document.querySelector(e)).val(),c=b.val()===a;d.$setValidity("passwordmatch",c)})})}}}]),app.directive("complexPassword",function(){return{require:"ngModel",link:function(a,b,c,d){d.$parsers.unshift(function(a){var b=/[A-Z]/.test(a),c=/[a-z]/.test(a),e=/\d/.test(a),f=/\W/.test(a),g=b+c+e+f;return a.length>=8&&g>=3?(d.$setValidity("complexity",!0),a):void d.$setValidity("complexity",!1)})}}}),angular.module("web").directive("emails",function(){return{restrict:"E",scope:{emails:"="},template:'<div class="input-group" style="clear: both;"><input type="email" class="form-control" ng-model="newEmail" placeholder="email"/><span class="input-group-btn" style="width:0px;"></span><span class="input-group-btn"><button class="btn btn-primary" ng-click="add()" ng-disabled="!newEmail"><span class="glyphicon glyphicon-plus"></span></button></span></div><div class="tags" style="margin-top: 5px"><div ng-repeat="mail in emails track by $index" class="tag label label-success" ng-click="remove($index)"><span class="glyphicon glyphicon-remove"></span><div class="tag-value">{{mail}}</div></div></div>',link:function(a,b){a.newEmail="";var c=angular.element(b[0].querySelectorAll("input"));a.add=function(){a.newEmail&&(a.emails.push(a.newEmail),a.newEmail=""),event.preventDefault()},a.remove=function(b){a.emails.splice(b,1)},c.bind("keypress",function(b){a.newEmail&&13==b.keyCode&&(b.preventDefault(),a.$apply(a.add))})}}}),angular.module("web").directive("jqCron",function(){return{restrict:"E",require:"ngModel",scope:{ngModel:"="},link:function(a,b,c,d){var e={initial:a.ngModel||"* * * * *",onChange:function(){var b=$(this).cron("value");a.ngModel=b,d.$viewValue!=b&&d.$setViewValue(b)}};$(b).cron(e)}}}),angular.module("web").directive("stFilter",function(){return{require:"^stTable",scope:{stFilter:"="},link:function(a,b,c,d){a.$watch("stFilter",function(a){d.search(a,"availabilityZone")})}}}),angular.module("web").directive("tagFilter",function(){return{restrict:"E",scope:{tags:"=",src:"=",keyph:"@",valueph:"@"},template:'<div class="input-group tag-input" style="clear: both;"><input type="text" class="form-control" ng-model="newTag.key" placeholder="{{keyph}}" typeahead="key for key in srcKeys | filter:$viewValue" typeahead-editable="false"/><span class="input-group-btn" style="width:0px;"></span><input type="text" class="form-control" ng-model="newTag.value" placeholder="{{valueph}}" style="border-left: 0" typeahead="val for val in src[newTag.key] | filter:$viewValue" typeahead-editable="false" /><span class="input-group-btn"><button class="btn btn-primary" ng-click="add()"><span class="glyphicon glyphicon-plus"></span></button></span></div><div class="tags"><div ng-repeat="tag in tags track by $index" class="tag label label-success" ng-click="remove($index)"><span class="glyphicon glyphicon-remove"></span><div class="tag-value">{{tag.key}} : {{tag.value}}</div></div></div>',
link:function(a,b,c){a.newTag={},a.srcKeys=[];var d=angular.element(b[0].querySelectorAll("input"));a.$watch("src",function(b){a.srcKeys=Object.keys(b)||[]}),a.add=function(){a.newTag.hasOwnProperty("key")&&a.newTag.hasOwnProperty("value")&&(a.tags.push(a.newTag),a.newTag={}),event.preventDefault()},a.remove=function(b){a.tags.splice(b,1)},d.bind("keypress",function(b){""!=a.newTag.key&&""!=a.newTag.value&&13==b.keyCode&&(b.preventDefault(),a.$apply(a.add))})}}}),app.directive("uploadedFile",function(){return{scope:{uploadedFile:"="},link:function(a,b,c){b.bind("change",function(b){var c=b.target.files[0];a.uploadedFile=c?c:void 0,a.$apply()})}}}),angular.module("web").filter("sizeConvertion",function(){return function(a){var b=a/1024/1024/1024;if(a)return b<1?parseInt(a/1024/1024)+" MB":parseInt(a/1024/1024/1024)+" GB"}}),angular.module("web").filter("stAdvancedFilter",function(){var a=function(a,b,c){var d={str:function(){return 0==b.length||!!a&&a.toLowerCase().indexOf(b.toLowerCase())>-1},"str-strict":function(){return 0==b.length||!!a&&a===b},"int-range":function(){return b.lower<=a&&b.higher>=a},"array-inc":function(){return 0==b.length||a.length>0&&function(){for(var c=0;c<b.length;c++)for(var d=b[c],e=0;e<a.length;e++){var f=a[e];if(f.key===d.key&&f.value===d.value)return!0}return!1}()}};return d[c]()},b=function(b,c){for(var d=Object.keys(c),e=0;e<d.length;e++){var f=d[e];if(!a(b[f],c[f].value,c[f].type))return!1}return!0};return function(a,c){if(!angular.isUndefined(a)&&!angular.isUndefined(c)&&a.length>0){var d=[];return a.forEach(function(a){b(a,c)&&d.push(a)}),d}return a}}),angular.module("web").service("Auth",["Storage","$q","$http","BASE_URL",function(a,b,c,d){var e=d+"login",f=d+"logout",g={404:"Service is unavailable",401:"Your authentication information was incorrect. Please try again"},h=function(d,f){var h=b.defer();return c({method:"POST",url:e,headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:function(a){var b=[];for(var c in a)b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")},data:{email:d,password:f}}).then(function(b){a.save("currentUser",b.data),h.resolve(b.data)},function(a,b){h.reject(g[b])}),h.promise},i=function(){return a.remove("ssoMode"),a.remove("currentUser"),c.get(f)};return{logIn:function(a,b){return h(a,b)},logOut:function(){return i()}}}]),angular.module("web").service("Backups",["$q","$http","BASE_URL",function(a,b,c){var d=c+"rest/backup",e=function(c){var e=a.defer();return b.get(d+"/"+c).success(function(a){e.resolve(a)}).error(function(a){e.reject(a)}),e.promise},f=function(a){return b.delete(d+"/"+a).success(function(){}).error(function(a){})};return{getForVolume:function(a){return e(a)},delete:function(a){return f(a)}}}]),angular.module("web").service("Configuration",["$q","$http","BASE_URL",function(a,b,c){var d=c+"rest/configuration",e=function(c){var e=a.defer();return b({url:d+"/"+c,method:"GET"}).then(function(a,b){e.resolve(a,b)},function(a,b){e.reject(a,b)}),e.promise},f=function(c,e,f,h){var i=a.defer();h&&g(e,h).then(function(a){console.info("Files uploaded successfully")},function(){return i.reject()});var j={url:d+"/"+c,method:"POST",data:e||{}};return f&&(j.timeout=f),b(j).then(function(){i.resolve()},function(a,b){i.reject(a,b)}),i.promise},g=function(c,e){var f=a.defer(),g=new FormData,h=["idp_metadata.xml","saml_sp_cert.pem"];for(var i in e)g.append("file",e[i]);return g.append("name",h),b({url:d+"/uploadFiles",method:"POST",data:g,transformRequest:angular.identity,transformResponse:angular.identity,headers:{"Content-Type":void 0}}).then(function(){f.resolve()},function(a){console.warn(a.data),f.reject()}),delete c.sso,f.promise},h=function(c){var d=a.defer(),e={url:"/rest/system/mail/configuration/test",method:"POST",data:c};return b(e).then(function(a){d.resolve(a)},function(a){d.reject(a)}),d.promise};return{get:function(a){return e(a)},send:function(a,b,c,d){return f(a,b,c,d)},check:function(a){return h(a)}}}]),angular.module("web").service("Exception",["toastr",function(a){return{handle:function(b){a.error((b.data||{}).localizedMessage||"Error occurred!"),console.log(b)}}}]),angular.module("web").factory("Interceptor",["$q","Exception",function(a,b){return{responseError:function(c){if(500===c.status&&c.data.localizedMessage)b.handle(c);else if(401===c.status){var d="#/login?err=session",e="/saml/logout",f=c.data&&c.data.loginMode&&"SSO"===c.data.loginMode;window.location=f?e:d}return a.reject(c)}}}]),angular.module("web").service("Regions",["$q","$http","BASE_URL",function(a,b,c){var d=c+"rest/regions";return{get:function(){var c=a.defer();return b.get(d).success(function(a){c.resolve(a)}),c.promise}}}]),angular.module("web").service("Retention",["$q","$http","BASE_URL",function(a,b,c){var d=c+"rest/retention",e=function(c){var e=a.defer();return b({url:d+"/"+c,method:"GET"}).success(function(a){e.resolve(a)}),e.promise},f=function(a){return b({url:d,method:"POST",data:a})};return{get:function(a){return e(a)},update:function(a){return f(a)}}}]),angular.module("web").service("Storage",[function(){return{get:function(a){return JSON.parse(sessionStorage.getItem(a))},save:function(a,b){sessionStorage.setItem(a,JSON.stringify(b))},remove:function(a){sessionStorage.removeItem(a)},clearAll:function(){sessionStorage.clear()}}}]),angular.module("web").service("System",["$q","$http","BASE_URL",function(a,b,c){var d=c+"rest/system",e=function(){var c=a.defer();return b.get(d).then(function(a){c.resolve(a.data)},function(a){c.reject(a)}),c.promise},f=function(c){var e=a.defer();return b({url:d,method:"POST",data:c}).then(function(a){e.resolve(a.data)},function(a){e.reject(a)}),e.promise},g=function(c){var e=a.defer();return b.post(d+"/delete",c).then(function(a){e.resolve(a.data)},function(a){e.reject(a)}),e.promise};return{get:function(){return e()},send:function(a){return f(a)},delete:function(a){return g(a)}}}]),angular.module("web").service("Tasks",["$q","$http","Storage","BASE_URL",function(a,b,c,d){var e=d+"rest/task",f=function(c){var d=a.defer();return b.get(e+(c?"/"+c:"")).then(function(a){d.resolve(a.data)},function(a){d.reject(a)}),d.promise},g=function(c){var d=a.defer();return b.get(e+"/regular/"+c).then(function(a){d.resolve(a.data)},function(a){d.reject(a)}),d.promise},h=function(a){return b({url:e,method:"PUT",data:a})},i=function(a){return b({url:e+"/"+a,method:"DELETE"})},j=function(a){return b({url:e,method:"POST",data:a})};return{get:function(a){return f(a)},getRegular:function(a){return g(a)},update:function(a){return h(a)},insert:function(a){return j(a)},delete:function(a){return i(a)}}}]),angular.module("web").service("Users",["$q","$http","Storage","BASE_URL",function(a,b,c,d){var e=d+"rest/user",f=function(){var c=a.defer();return b({url:e,method:"GET"}).then(function(a){c.resolve(a.data)},function(a){c.reject(a)}),c.promise},g=function(c){var d=a.defer();return b({url:e,method:"POST",data:c}).then(function(a){d.resolve(a.data)},function(a){d.reject(a)}),d.promise},h=function(a){return b({url:e,method:"PUT",data:a})},i=function(){return c.get("currentUser")},j=function(){var d=a.defer();return b({url:e+"/currentUser",method:"GET"}).then(function(a){a.data.email&&c.save("currentUser",a.data),d.resolve(a)},function(a){d.reject(a)}),d.promise},k=function(a){return b({url:e+"/"+a,method:"DELETE"})};return{insert:function(a){return g(a)},delete:function(a){return k(a)},update:function(a){return h(a)},getCurrent:function(){return i()},refreshCurrent:function(){return j()},getAll:function(){return f().then(function(a){return a})}}}]),angular.module("web").service("Volumes",["$q","$http","Storage","BASE_URL",function(a,b,c,d){var e=d+"rest/volume";return{get:function(){var c=a.defer();return b.get(e).then(function(a){var b=a.data;c.resolve(b)},function(a,b){c.reject(a,b)}),c.promise}}}]),angular.module("web").service("Zones",["$q","$http","BASE_URL",function(a,b,c){var d=c+"rest/zones",e=function(c){var e=a.defer();return b.get(d+(c||"")).success(function(a){e.resolve(a)}).error(function(a){e.reject(a)}),e.promise};return{get:function(){return e()},getCurrent:function(){return e("/current")}}}]);